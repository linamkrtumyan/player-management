/**
 * Валидация сумм для финансовых операций.
 *
 * Ограничение до 2 знаков после запятой в финансовых приложениях критически важно по следующим причинам:
 *
 * 1. Соответствие реальным валютам:
 *    Большинство валют мира используют 2 знака после запятой (копейки, центы, пенсы).
 *    Использование большего количества знаков создаёт путаницу и несоответствие с реальными денежными единицами.
 *
 * 2. Предсказуемость расчётов и избежание ошибок округления:
 *    При работе с числами с плавающей точкой (float) накопление погрешности может привести к серьёзным
 *    финансовым расхождениям. Ограничение до 2 знаков минимизирует эти риски и делает расчёты предсказуемыми.
 *
 * 3. Защита от некорректного ввода и опечаток:
 *    Пользователь может случайно ввести лишние знаки (например, 100.567 вместо 100.56).
 *    Валидация предотвращает такие ошибки на этапе ввода, до отправки на сервер.
 *
 * 4. Единообразие с бэкендом и отчётностью:
 *    Финансовые системы должны использовать одинаковую точность во всех компонентах.
 *    Это обеспечивает согласованность данных между фронтендом, бэкендом и отчётами.
 *
 * 5. Соответствие стандартам финансовых систем:
 *    Банковские протоколы и стандарты финансовых транзакций (ISO 4217, SWIFT) используют 2 знака.
 *    Соблюдение этих стандартов необходимо для интеграции с внешними системами.
 *
 * 6. Защита от мошенничества и ошибок:
 *    Некорректные суммы могут быть использованы для обхода проверок или привести к финансовым потерям.
 *    Валидация на клиенте — первый уровень защиты от таких проблем.
 */

const MAX_DECIMAL_PLACES = 2;
const DECIMAL_REGEX = new RegExp(
  `^-?\\d+(\\.\\d{1,${MAX_DECIMAL_PLACES}})?$`
);

export interface AmountValidationResult {
  valid: boolean;
  error?: string;
  value?: number;
}

/**
 * Проверяет строку суммы: число, не более 2 знаков после запятой, положительное.
 * Примеры: "100.50" ✓, "100.567" ✗, "0" ✗ (для операций обычно требуют > 0).
 */
export function validateAmount(input: string): AmountValidationResult {
  const trimmed = input.trim();
  if (trimmed === '') {
    return { valid: false, error: 'Введите сумму' };
  }
  const num = Number(trimmed);
  if (Number.isNaN(num)) {
    return { valid: false, error: 'Сумма должна быть числом' };
  }
  if (num <= 0) {
    return { valid: false, error: 'Сумма должна быть больше нуля' };
  }
  if (!DECIMAL_REGEX.test(trimmed)) {
    return {
      valid: false,
      error: `Допускается не более ${MAX_DECIMAL_PLACES} знаков после запятой (например, 100.50)`,
    };
  }
  return { valid: true, value: num };
}

/**
 * Проверка только формата (для отображения ошибки в реальном времени).
 */
export function isDecimalFormatValid(input: string): boolean {
  if (input.trim() === '') return true;
  return DECIMAL_REGEX.test(input.trim()) || input.endsWith('.');
}
